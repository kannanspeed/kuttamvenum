{% extends "base.html" %}

{% block title %}User Dashboard - Political Event Management{% endblock %}

{% block content %}
<!-- Welcome Section -->
<div class="welcome-section mb-4">
    <div class="card">
        <div class="d-flex justify-between align-center">
            <div>
                <h2 style="color: #333; margin-bottom: 10px;">
                    <i class="fas fa-user-circle"></i> Welcome, {{ user.name }}!
                </h2>
                <p style="color: #666; margin: 0;">
                    <i class="fas fa-map-marker-alt"></i> {{ user.location }} | 
                    <i class="fas fa-envelope"></i> {{ user.email }} | 
                    <i class="fas fa-phone"></i> {{ user.phone }}
                </p>
            </div>
            <div class="user-status">
                <span class="status-badge status-approved">
                    <i class="fas fa-check-circle"></i> Verified User
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Stats Section -->
<div class="stats-section mb-4">
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ events|length }}</div>
            <div class="stat-label">Available Events</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ registrations|length }}</div>
            <div class="stat-label">Events Joined</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">
                {{ registrations|selectattr('status', 'equalto', 'checked_in')|list|length }}
            </div>
            <div class="stat-label">Events Attended</div>
        </div>
    </div>
</div>

<!-- Search and Filter Section -->
<div class="search-filter-section mb-4">
    <div class="card">
        <div class="d-flex justify-between align-center" style="gap: 20px;">
            <div style="flex: 1;">
                <input type="text" id="search-events" class="form-control" 
                       placeholder="Search events by title or description...">
            </div>
            <div style="min-width: 200px;">
                <select id="filter-party" class="form-control">
                    <option value="all">All Parties</option>
                    {% set parties = events|map(attribute='party_name')|unique|list %}
                    {% for party in parties %}
                        <option value="{{ party }}">{{ party }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Events Section -->
<div class="events-section">
    <div class="section-header mb-4">
        <h3 style="color: white; font-size: 1.8rem; font-weight: bold;">
            <i class="fas fa-calendar-alt"></i> Available Political Events
        </h3>
    </div>

    {% if events %}
        <div class="events-grid">
            {% for event in events %}
                <div class="event-card" data-event-id="{{ event.id }}">
                    {% if event.image %}
                        <img src="{{ url_for('static', filename='uploads/' + event.image) }}" 
                             alt="{{ event.title }}" class="event-image">
                    {% else %}
                        <div class="event-image-placeholder">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                    {% endif %}
                    
                    <div class="event-content">
                        <h4 class="event-title">{{ event.title }}</h4>
                        <div class="event-party">
                            <i class="fas fa-flag"></i> {{ event.party_name }}
                        </div>
                        <p class="event-description">{{ event.description[:150] }}{% if event.description|length > 150 %}...{% endif %}</p>
                        
                        <div class="event-details">
                            <div class="event-date">
                                <i class="fas fa-calendar"></i> 
                                {{ event.date.strftime('%B %d, %Y') }}
                            </div>
                            <div class="event-time">
                                <i class="fas fa-clock"></i> 
                                {{ event.time.strftime('%I:%M %p') }}
                            </div>
                        </div>

                        <div class="event-actions">
                            {% set user_registration = registrations|selectattr('event_id', 'equalto', event.id)|first %}
                            {% if user_registration %}
                                {% if user_registration.status == 'registered' %}
                                    <span class="status-badge status-registered">
                                        <i class="fas fa-check"></i> Registered
                                    </span>
                                    <a href="{{ url_for('scan_qr', event_id=event.id) }}" 
                                       class="btn btn-success scan-qr-btn" data-event-id="{{ event.id }}">
                                        <i class="fas fa-qrcode"></i> Scan QR
                                    </a>
                                {% elif user_registration.status == 'checked_in' %}
                                    <span class="status-badge status-checked-in">
                                        <i class="fas fa-check-double"></i> Checked In
                                    </span>
                                    <span class="check-in-time">
                                        Checked in at {% if user_registration.check_in_time is string %}{{ user_registration.check_in_time }}{% else %}{{ user_registration.check_in_time.strftime('%I:%M %p') }}{% endif %}
                                    </span>
                                {% endif %}
                            {% else %}
                                <a href="{{ url_for('join_event', event_id=event.id) }}" 
                                   class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Join Event
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="card text-center">
            <i class="fas fa-calendar-times" style="font-size: 3rem; color: #667eea; margin-bottom: 20px;"></i>
            <h3 style="color: #333; margin-bottom: 10px;">No Events Available</h3>
            <p style="color: #666;">There are currently no upcoming political events. Check back later!</p>
        </div>
    {% endif %}
</div>

<!-- My Events Section -->
{% if registrations %}
<div class="my-events-section mt-5">
    <div class="section-header mb-4">
        <h3 style="color: white; font-size: 1.8rem; font-weight: bold;">
            <i class="fas fa-list"></i> My Events
        </h3>
    </div>

    <div class="my-events-grid">
        {% for registration in registrations %}
            {% set event = events|selectattr('id', 'equalto', registration.event_id)|first %}
            {% if event %}
                <div class="event-card my-event-card">
                    {% if event.image %}
                        <img src="{{ url_for('static', filename='uploads/' + event.image) }}" 
                             alt="{{ event.title }}" class="event-image">
                    {% else %}
                        <div class="event-image-placeholder">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                    {% endif %}
                    
                    <div class="event-content">
                        <h4 class="event-title">{{ event.title }}</h4>
                        <div class="event-party">
                            <i class="fas fa-flag"></i> {{ event.party_name }}
                        </div>
                        
                        <div class="event-details">
                            <div class="event-date">
                                <i class="fas fa-calendar"></i> 
                                {{ event.date.strftime('%B %d, %Y') }}
                            </div>
                            <div class="event-time">
                                <i class="fas fa-clock"></i> 
                                {{ event.time.strftime('%I:%M %p') }}
                            </div>
                        </div>

                        <div class="registration-status">
                            {% if registration.status == 'registered' %}
                                <span class="status-badge status-registered">
                                    <i class="fas fa-check"></i> Registered
                                </span>
                                <p style="color: #666; font-size: 0.9rem; margin-top: 10px;">
                                    Don't forget to scan the QR code when you arrive at the event!
                                </p>
                            {% elif registration.status == 'checked_in' %}
                                <span class="status-badge status-checked-in">
                                    <i class="fas fa-check-double"></i> Checked In
                                </span>
                                <p style="color: #56ab2f; font-size: 0.9rem; margin-top: 10px;">
                                    <i class="fas fa-clock"></i> 
                                    Checked in at {% if registration.check_in_time is string %}{{ registration.check_in_time }}{% else %}{{ registration.check_in_time.strftime('%I:%M %p') }}{% endif %}
                                </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>
</div>
{% endif %}

<style>
.welcome-section .card {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
}

.welcome-section h2 {
    color: white !important;
}

.welcome-section p {
    color: rgba(255, 255, 255, 0.9) !important;
}

.status-badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.status-approved {
    background: rgba(86, 171, 47, 0.2);
    color: #56ab2f;
    border: 1px solid #56ab2f;
}

.status-registered {
    background: rgba(102, 126, 234, 0.2);
    color: #667eea;
    border: 1px solid #667eea;
}

.status-checked-in {
    background: rgba(86, 171, 47, 0.2);
    color: #56ab2f;
    border: 1px solid #56ab2f;
}

.events-grid, .my-events-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 25px;
}

.event-image-placeholder {
    width: 100%;
    height: 200px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 3rem;
}

.event-details {
    display: flex;
    gap: 20px;
    margin-bottom: 15px;
    font-size: 0.9rem;
    color: #666;
}

.event-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 15px;
}

.check-in-time {
    font-size: 0.9rem;
    color: #56ab2f;
    font-weight: 600;
}

.registration-status {
    margin-top: 15px;
}

.section-header {
    border-bottom: 2px solid rgba(255, 255, 255, 0.2);
    padding-bottom: 10px;
}

@media (max-width: 768px) {
    .events-grid, .my-events-grid {
        grid-template-columns: 1fr;
    }
    
    .search-filter-section .d-flex {
        flex-direction: column;
    }
    
    .event-actions {
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
    }
    
    .event-details {
        flex-direction: column;
        gap: 5px;
    }
}
</style>

<script>
// Search and filter functionality
document.getElementById('search-events').addEventListener('input', filterEvents);
document.getElementById('filter-party').addEventListener('change', filterEvents);

function filterEvents() {
    const searchTerm = document.getElementById('search-events').value.toLowerCase();
    const filterParty = document.getElementById('filter-party').value;
    const eventCards = document.querySelectorAll('.event-card');
    
    eventCards.forEach(card => {
        const title = card.querySelector('.event-title').textContent.toLowerCase();
        const party = card.querySelector('.event-party').textContent;
        const description = card.querySelector('.event-description').textContent.toLowerCase();
        
        let showCard = true;
        
        // Search filter
        if (searchTerm) {
            showCard = title.includes(searchTerm) || description.includes(searchTerm);
        }
        
        // Party filter
        if (filterParty && filterParty !== 'all') {
            showCard = showCard && party.includes(filterParty);
        }
        
        // Show/hide card with animation
        if (showCard) {
            card.style.display = 'block';
            setTimeout(() => {
                card.style.opacity = '1';
                card.style.transform = 'scale(1)';
            }, 50);
        } else {
            card.style.opacity = '0';
            card.style.transform = 'scale(0.8)';
            setTimeout(() => {
                card.style.display = 'none';
            }, 300);
        }
    });
}
</script>
{% endblock %}

